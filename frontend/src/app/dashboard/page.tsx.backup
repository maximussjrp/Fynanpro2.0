'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { toast } from 'sonner';
import api, { logout } from '@/lib/api';
import { useAuth, useUser, useTenant } from '@/stores/auth';
import TransactionModal from '@/components/NewTransactionModal';
import Logo from '@/components/Logo';
import { 
  DashboardMetricsSkeleton, 
  ChartSkeleton, 
  RankingCardSkeleton 
} from '@/components/Skeletons';
import { 
  Wallet, 
  TrendingUp, 
  TrendingDown, 
  DollarSign,
  LogOut,
  Settings,
  Calendar,
  Filter,
  X,
  Plus,
  ArrowUpRight,
  ArrowDownRight,
  PiggyBank,
  CreditCard
} from 'lucide-react';

interface DashboardData {
  balanceSummary?: any;
  expenseRanking?: any;
  incomeRanking?: any;
  incomeVsExpenses?: any;
}

interface Category {
  id: string;
  name: string;
  type: string;
  icon?: string;
  color?: string;
}

interface BankAccount {
  id: string;
  name: string;
  type: string;
  institution?: string;
  currentBalance: number;
}

interface PaymentMethod {
  id: string;
  name: string;
  type: string;
}

interface TransactionForm {
  amount: string;
  description: string;
  transactionDate: string;
  categoryId: string;
  bankAccountId: string;
  paymentMethodId: string;
  notes: string;
}

interface BankAccountForm {
  name: string;
  type: string;
  institution: string;
  initialBalance: string;
}

interface PaymentMethodForm {
  name: string;
  type: string;
  bankAccountId: string;
  lastFourDigits: string;
  cardNetwork: string;
  expirationDate: string;
}

export default function Dashboard() {
  const router = useRouter();
  const user = useUser();
  const tenant = useTenant();
  const { isAuthenticated } = useAuth();
  const [loading, setLoading] = useState(true);
  const [dashboardData, setDashboardData] = useState<DashboardData>({});
  const [showPeriodModal, setShowPeriodModal] = useState(false);
  const [showAddModal, setShowAddModal] = useState(false);
  const [showBankAccountModal, setShowBankAccountModal] = useState(false);
  const [showPaymentMethodModal, setShowPaymentMethodModal] = useState(false);
  const [addType, setAddType] = useState<'income' | 'expense'>('income');
  const [submitting, setSubmitting] = useState(false);
  const [categorySearch, setCategorySearch] = useState('');
  const [showCategoryDropdown, setShowCategoryDropdown] = useState(false);
  const [selectedCategoryName, setSelectedCategoryName] = useState('');
  
  // Dados para formul√°rio
  const [categories, setCategories] = useState<Category[]>([]);
  const [bankAccounts, setBankAccounts] = useState<BankAccount[]>([]);
  const [paymentMethods, setPaymentMethods] = useState<PaymentMethod[]>([]);
  
  // Formul√°rio de transa√ß√£o
  const [formData, setFormData] = useState<TransactionForm>({
    amount: '',
    description: '',
    transactionDate: new Date().toISOString().split('T')[0],
    categoryId: '',
    bankAccountId: '',
    paymentMethodId: '',
    notes: '',
  });
  
  // Formul√°rio de conta banc√°ria
  const [bankAccountForm, setBankAccountForm] = useState<BankAccountForm>({
    name: '',
    type: 'bank',
    institution: '',
    initialBalance: '0',
  });
  
  // Formul√°rio de meio de pagamento
  const [paymentMethodForm, setPaymentMethodForm] = useState<PaymentMethodForm>({
    name: '',
    type: 'pix',
    bankAccountId: '',
    lastFourDigits: '',
    cardNetwork: '',
    expirationDate: '',
  });
  
  // Filtros de per√≠odo
  const [startDate, setStartDate] = useState(() => {
    const date = new Date();
    date.setDate(1); // Primeiro dia do m√™s
    return date.toISOString().split('T')[0];
  });
  const [endDate, setEndDate] = useState(() => {
    const date = new Date();
    date.setMonth(date.getMonth() + 1);
    date.setDate(0); // √öltimo dia do m√™s
    return date.toISOString().split('T')[0];
  });

  useEffect(() => {
    if (!isAuthenticated) {
      router.push('/');
      return;
    }
    loadDashboardData();
    loadFormData();
  }, [startDate, endDate, isAuthenticated]);

  const loadDashboardData = async () => {
    try {
      setLoading(true);
      const params = { startDate, endDate };

      console.log('Carregando dashboard com per√≠odo:', params);

      // Carregar todos os dados em paralelo usando API client
      const [balance, expenseRank, incomeRank, incomeVsExp] = await Promise.all([
        api.get('/dashboard/balance-summary', { params }),
        api.get('/dashboard/expense-ranking', { params }),
        api.get('/dashboard/income-ranking', { params }),
        api.get('/dashboard/income-vs-expenses', { params }),
      ]);

      console.log('Resposta income-vs-expenses:', incomeVsExp.data);
      console.log('chartData extra√≠do:', incomeVsExp.data.data?.chartData);

      setDashboardData({
        balanceSummary: balance.data.data,
        expenseRanking: expenseRank.data.data,
        incomeRanking: incomeRank.data.data,
        incomeVsExpenses: incomeVsExp.data.data,
      });
    } catch (error: any) {
      console.error('Erro ao carregar dashboard:', error.response?.data || error.message);
      // O interceptor j√° trata 401 automaticamente
    } finally {
      setLoading(false);
    }
  };

  const loadFormData = async () => {
    try {
      console.log('Carregando categorias, contas e meios de pagamento...');

      const [categoriesRes, accountsRes, paymentsRes] = await Promise.all([
        api.get('/categories?isActive=true'),
        api.get('/bank-accounts?isActive=true'),
        api.get('/payment-methods?isActive=true'),
      ]);

      console.log('Dados carregados:', {
        categorias: categoriesRes.data.data.categories?.length || 0,
        contas: accountsRes.data.data.accounts?.length || 0,
        meios: paymentsRes.data.data.paymentMethods?.length || 0,
      });

      setCategories(categoriesRes.data.data.categories || []);
      setBankAccounts(accountsRes.data.data.accounts || []);
      setPaymentMethods(paymentsRes.data.data.paymentMethods || []);
    } catch (error: any) {
      console.error('Erro ao carregar dados do formul√°rio:', error.response?.data || error.message);
    }
  };

  // Fun√ß√£o para selecionar categoria
  const handleSelectCategory = (category: Category) => {
    setFormData({ ...formData, categoryId: category.id });
    setSelectedCategoryName(category.name);
    setCategorySearch('');
    setShowCategoryDropdown(false);
  };

  // Fun√ß√£o para filtrar e listar categorias hierarquicamente
  const getFilteredCategories = (categories: Category[], type: 'income' | 'expense', searchTerm: string) => {
    const results: Array<{ category: Category; level: number }> = [];
    
    // Filtrar apenas categorias de n√≠vel 1 (pais)
    const rootCategories = categories.filter(c => c.type === type && c.level === 1);
    
    rootCategories.forEach(parent => {
      // Adicionar categoria pai se corresponder √† busca
      if (parent.name.toLowerCase().includes(searchTerm.toLowerCase())) {
        results.push({ category: parent, level: 0 });
      }
      
      // Adicionar filhas (n√≠vel 2)
      if (parent.children && parent.children.length > 0) {
        parent.children.forEach(child => {
          if (child.name.toLowerCase().includes(searchTerm.toLowerCase())) {
            results.push({ category: child, level: 1 });
          }
          
          // Adicionar netas (n√≠vel 3)
          if (child.children && child.children.length > 0) {
            child.children.forEach(grandchild => {
              if (grandchild.name.toLowerCase().includes(searchTerm.toLowerCase())) {
                results.push({ category: grandchild, level: 2 });
              }
            });
          }
        });
      }
    });
    
    return results;
  };

  // Fun√ß√£o para renderizar categorias de forma hier√°rquica
  const renderCategoryOptions = (categories: Category[], type: 'income' | 'expense', searchTerm: string) => {
    const options: JSX.Element[] = [];
    
    // Filtrar apenas categorias de n√≠vel 1 (pais)
    const rootCategories = categories.filter(c => c.type === type && c.level === 1);
    
    rootCategories.forEach(parent => {
      // Adicionar categoria pai
      if (parent.name.toLowerCase().includes(searchTerm.toLowerCase())) {
        options.push(
          <option key={parent.id} value={parent.id}>
            {parent.icon} {parent.name}
          </option>
        );
      }
      
      // Adicionar filhas (n√≠vel 2)
      if (parent.children && parent.children.length > 0) {
        parent.children.forEach(child => {
          if (child.name.toLowerCase().includes(searchTerm.toLowerCase())) {
            options.push(
              <option key={child.id} value={child.id}>
                {'  '}{child.icon} {child.name}
              </option>
            );
          }
          
          // Adicionar netas (n√≠vel 3)
          if (child.children && child.children.length > 0) {
            child.children.forEach(grandchild => {
              if (grandchild.name.toLowerCase().includes(searchTerm.toLowerCase())) {
                options.push(
                  <option key={grandchild.id} value={grandchild.id}>
                    {'    '}{grandchild.icon} {grandchild.name}
                  </option>
                );
              }
            });
          }
        });
      }
    });
    
    return options;
  };

  const handleOpenAddModal = (type: 'income' | 'expense') => {
    setAddType(type);
    setFormData({
      amount: '',
      description: '',
      transactionDate: new Date().toISOString().split('T')[0],
      categoryId: '',
      bankAccountId: '',
      paymentMethodId: '',
      notes: '',
    });
    setCategorySearch('');
    setSelectedCategoryName('');
    setShowCategoryDropdown(false);
    setShowAddModal(true);
  };

  const handleSubmitTransaction = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!formData.amount || !formData.categoryId || !formData.bankAccountId) {
      toast.error('Preencha os campos obrigat√≥rios');
      return;
    }

    try {
      setSubmitting(true);

      await api.post('/transactions', {
        type: addType,
        amount: parseFloat(formData.amount),
        description: formData.description,
        transactionDate: formData.transactionDate,
        categoryId: formData.categoryId,
        bankAccountId: formData.bankAccountId,
        paymentMethodId: formData.paymentMethodId || null,
        notes: formData.notes || null,
        status: 'completed',
      });

      // Fechar modal e recarregar dados
      setShowAddModal(false);
      loadDashboardData();
      toast.success(`${addType === 'income' ? 'Receita' : 'Despesa'} cadastrada com sucesso!`);
    } catch (error: any) {
      console.error('Erro ao criar transa√ß√£o:', error);
      toast.error(error.response?.data?.error?.message || 'Erro ao criar transa√ß√£o');
    } finally {
      setSubmitting(false);
    }
  };

  const handleCreateBankAccount = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      setSubmitting(true);
      const response = await api.post('/bank-accounts', {
        name: bankAccountForm.name,
        type: bankAccountForm.type,
        institution: bankAccountForm.institution,
        initialBalance: parseFloat(bankAccountForm.initialBalance),
      });

      // Fechar modal e recarregar lista de contas
      setShowBankAccountModal(false);
      await loadFormData(); // Recarregar contas
      setFormData({ ...formData, bankAccountId: response.data.data.id }); // Auto-selecionar nova conta
      setBankAccountForm({ name: '', type: 'bank', institution: '', initialBalance: '0' }); // Reset form
      toast.success('Conta banc√°ria criada com sucesso!');
    } catch (error: any) {
      console.error('Erro ao criar conta banc√°ria:', error);
      toast.error(error.response?.data?.error?.message || 'Erro ao criar conta banc√°ria');
    } finally {
      setSubmitting(false);
    }
  };

  const handleCreatePaymentMethod = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      setSubmitting(true);
      
      const payload: any = {
        name: paymentMethodForm.name,
        type: paymentMethodForm.type,
      };

      // Adicionar campos espec√≠ficos para cart√µes
      if (paymentMethodForm.type === 'credit_card' || paymentMethodForm.type === 'debit_card') {
        payload.bankAccountId = paymentMethodForm.bankAccountId || null;
        payload.lastFourDigits = paymentMethodForm.lastFourDigits || null;
        payload.cardNetwork = paymentMethodForm.cardNetwork || null;
        if (paymentMethodForm.expirationDate) {
          payload.expirationDate = new Date(paymentMethodForm.expirationDate).toISOString();
        }
      } else if (paymentMethodForm.type === 'pix' || paymentMethodForm.type === 'bank_transfer') {
        payload.bankAccountId = paymentMethodForm.bankAccountId || null;
      }

      const response = await api.post('/payment-methods', payload);

      // Fechar modal e recarregar lista de meios de pagamento
      setShowPaymentMethodModal(false);
      await loadFormData(); // Recarregar meios de pagamento
      setFormData({ ...formData, paymentMethodId: response.data.data.id }); // Auto-selecionar novo meio
      setPaymentMethodForm({ 
        name: '', 
        type: 'pix', 
        bankAccountId: '', 
        lastFourDigits: '', 
        cardNetwork: '', 
        expirationDate: '' 
      }); // Reset form
      toast.success('Meio de pagamento criado com sucesso!');
    } catch (error: any) {
      console.error('Erro ao criar meio de pagamento:', error);
      toast.error(error.response?.data?.error?.message || 'Erro ao criar meio de pagamento');
    } finally {
      setSubmitting(false);
    }
  };

  const handleLogout = () => {
    logout(); // Usa fun√ß√£o do lib/api.ts que limpa tudo e redireciona
  };

  const formatCurrency = (value: number) => {
    return new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(value);
  };

  const formatMonth = (monthStr: string) => {
    const [year, month] = monthStr.split('-');
    const date = new Date(parseInt(year), parseInt(month) - 1);
    return date.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
  };

  const applyQuickFilter = (type: string) => {
    const today = new Date();
    let start = new Date();
    let end = new Date();

    switch (type) {
      case 'currentMonth':
        start = new Date(today.getFullYear(), today.getMonth(), 1);
        end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        break;
      case 'lastMonth':
        start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        end = new Date(today.getFullYear(), today.getMonth(), 0);
        break;
      case 'last3Months':
        start = new Date(today.getFullYear(), today.getMonth() - 2, 1);
        end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        break;
      case 'last6Months':
        start = new Date(today.getFullYear(), today.getMonth() - 5, 1);
        end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        break;
      case 'currentYear':
        start = new Date(today.getFullYear(), 0, 1);
        end = new Date(today.getFullYear(), 11, 31);
        break;
    }

    setStartDate(start.toISOString().split('T')[0]);
    setEndDate(end.toISOString().split('T')[0]);
    setShowPeriodModal(false);
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 p-6">
        {/* Header Skeleton */}
        <div className="mb-8">
          <div className="flex items-center justify-between mb-6">
            <div>
              <div className="h-8 w-64 bg-gray-200 rounded animate-pulse mb-2"></div>
              <div className="h-5 w-48 bg-gray-200 rounded animate-pulse"></div>
            </div>
            <div className="h-10 w-32 bg-gray-200 rounded animate-pulse"></div>
          </div>
        </div>

        {/* Metrics Cards Skeleton */}
        <DashboardMetricsSkeleton />

        {/* Charts Skeleton */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <ChartSkeleton height={350} />
          <ChartSkeleton height={350} />
        </div>

        {/* Rankings Skeleton */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <RankingCardSkeleton items={5} />
          <RankingCardSkeleton items={5} />
        </div>
      </div>
    );
  }

  const balance = dashboardData.balanceSummary?.summary;
  const expenseData = dashboardData.expenseRanking;
  const incomeData = dashboardData.incomeRanking;
  const chartData = dashboardData.incomeVsExpenses?.chartData || [];

  return (
    <div className="min-h-screen bg-[#F4F7FB]">
      {/* Header */}
      <header className="bg-white shadow-sm border-b sticky top-0 z-10">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Logo variant="horizontal-light" format="svg" className="h-12 w-auto" />
            </div>
            
            <div className="flex items-center gap-4">
              <button
                onClick={() => setShowPeriodModal(true)}
                className="flex items-center gap-2 px-4 py-2 bg-[#E8F4FD] text-[#1C6DD0] rounded-lg hover:bg-[#D6EBFA] transition-colors"
                style={{fontFamily: 'Inter, sans-serif'}}
              >
                <Filter className="w-5 h-5" />
                <span className="hidden sm:inline font-medium">Per√≠odo</span>
              </button>
              <button className="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                <Settings className="w-5 h-5 text-[#4F4F4F]" />
              </button>
              <button 
                onClick={handleLogout}
                className="flex items-center gap-2 px-4 py-2 text-[#E74C3C] hover:bg-[#FEF2F2] rounded-lg transition-colors"
                style={{fontFamily: 'Inter, sans-serif'}}
              >
                <LogOut className="w-5 h-5" />
                <span className="hidden sm:inline font-medium">Sair</span>
              </button>
            </div>
          </div>

          {/* Menu de Navega√ß√£o */}
          <nav className="mt-4 flex gap-2 overflow-x-auto">
            <button
              onClick={() => router.push('/dashboard')}
              className="px-4 py-2 text-sm font-medium text-[#1C6DD0] bg-[#E8F4FD] rounded-lg whitespace-nowrap"
              style={{fontFamily: 'Inter, sans-serif'}}
            >
              üìä Dashboard
            </button>
            <button
              onClick={() => router.push('/dashboard/transactions')}
              className="px-4 py-2 text-sm font-medium text-[#4F4F4F] hover:bg-gray-100 rounded-lg whitespace-nowrap"
              style={{fontFamily: 'Inter, sans-serif'}}
            >
              üìã Transa√ß√µes
            </button>
            <button
              onClick={() => router.push('/dashboard/bank-accounts')}
              className="px-4 py-2 text-sm font-medium text-[#4F4F4F] hover:bg-gray-100 rounded-lg whitespace-nowrap"
              style={{fontFamily: 'Inter, sans-serif'}}
            >
              üè¶ Contas
            </button>
            <button
              onClick={() => router.push('/dashboard/categories')}
              className="px-4 py-2 text-sm font-medium text-[#4F4F4F] hover:bg-gray-100 rounded-lg whitespace-nowrap"
              style={{fontFamily: 'Inter, sans-serif'}}
            >
              üè∑Ô∏è Categorias
            </button>
            <button
              onClick={() => router.push('/dashboard/payment-methods')}
              className="px-4 py-2 text-sm font-medium text-[#4F4F4F] hover:bg-gray-100 rounded-lg whitespace-nowrap"
              style={{fontFamily: 'Inter, sans-serif'}}
            >
              üí≥ Pagamentos
            </button>
            <button
              onClick={() => router.push('/dashboard/recurring-bills')}
              className="px-4 py-2 text-sm font-medium text-[#4F4F4F] hover:bg-gray-100 rounded-lg whitespace-nowrap"
              style={{fontFamily: 'Inter, sans-serif'}}
            >
              üîÑ Recorrentes
            </button>
            <button
              onClick={() => router.push('/dashboard/installments')}
              className="px-4 py-2 text-sm font-medium text-[#4F4F4F] hover:bg-gray-100 rounded-lg whitespace-nowrap"
              style={{fontFamily: 'Inter, sans-serif'}}
            >
              üìä Parcelamentos
            </button>
            <button
              onClick={() => router.push('/dashboard/budgets')}
              className="px-4 py-2 text-sm font-medium text-[#4F4F4F] hover:bg-gray-100 rounded-lg whitespace-nowrap"
              style={{fontFamily: 'Inter, sans-serif'}}
            >
              üí∞ Or√ßamentos
            </button>
            <button
              onClick={() => router.push('/dashboard/reports')}
              className="px-4 py-2 text-sm font-medium text-[#4F4F4F] hover:bg-gray-100 rounded-lg whitespace-nowrap"
              style={{fontFamily: 'Inter, sans-serif'}}
            >
              üìä Relat√≥rios
            </button>
            <button
              onClick={() => router.push('/dashboard/calendar')}
              className="px-4 py-2 text-sm font-medium text-[#4F4F4F] hover:bg-gray-100 rounded-lg whitespace-nowrap"
              style={{fontFamily: 'Inter, sans-serif'}}
            >
              üìÖ Calend√°rio
            </button>
          </nav>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Per√≠odo Selecionado */}
        <div className="mb-6 flex items-center gap-3 text-sm text-[#4F4F4F]" style={{fontFamily: 'Inter, sans-serif'}}>
          <Calendar className="w-4 h-4" />
          <span>
            {new Date(startDate).toLocaleDateString('pt-BR')} - {new Date(endDate).toLocaleDateString('pt-BR')}
          </span>
        </div>

        {/* 1. Saldo Final Detalhado */}
        <div className="bg-gradient-to-r from-[#1C6DD0] to-[#1557A8] rounded-xl p-6 mb-8 text-white shadow-lg">
          <h2 className="text-lg font-semibold mb-6" style={{fontFamily: 'Poppins, sans-serif'}}>Saldo Final do Per√≠odo</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            {/* COLUNA RECEITAS */}
            <div className="bg-white/10 rounded-lg p-4">
              <h3 className="text-sm font-medium text-blue-100 mb-3">üí∞ RECEITAS</h3>
              
              <div className="mb-4">
                <p className="text-xs text-blue-200 mb-1">Total de Receitas</p>
                <p className="text-2xl font-bold">{formatCurrency(balance?.totalIncome || 0)}</p>
              </div>
              
              <div className="space-y-2 text-sm">
                <div className="flex justify-between items-center">
                  <span className="text-blue-200">‚úÖ Receitas Recebidas</span>
                  <span className="font-semibold">{formatCurrency(balance?.receivedIncome || 0)}</span>
                </div>
                <div className="flex justify-between items-center">
                  <span className="text-blue-200">‚è≥ Receitas a Receber</span>
                  <span className="font-semibold">{formatCurrency(balance?.pendingIncome || 0)}</span>
                </div>
              </div>
            </div>

            {/* COLUNA DESPESAS */}
            <div className="bg-white/10 rounded-lg p-4">
              <h3 className="text-sm font-medium text-blue-100 mb-3">üí∏ DESPESAS</h3>
              
              <div className="mb-4">
                <p className="text-xs text-blue-200 mb-1">Total de Despesas</p>
                <p className="text-2xl font-bold">{formatCurrency(balance?.totalExpense || 0)}</p>
              </div>
              
              <div className="space-y-2 text-sm">
                <div className="flex justify-between items-center">
                  <span className="text-blue-200">‚úÖ Despesas Pagas</span>
                  <span className="font-semibold">{formatCurrency(balance?.paidExpense || 0)}</span>
                </div>
                <div className="flex justify-between items-center">
                  <span className="text-blue-200">‚è≥ Despesas a Pagar</span>
                  <span className="font-semibold">{formatCurrency(balance?.pendingExpense || 0)}</span>
                </div>
              </div>
            </div>
          </div>

          {/* SALDO FINAL */}
          <div className="border-t border-white/20 pt-4">
            <div className={`rounded-lg p-4 text-center ${balance?.isPositive ? 'bg-[#22C39A]/20' : 'bg-[#E74C3C]/20'}`}>
              <p className="text-sm text-white mb-2 font-medium">Saldo Final (Receitas - Despesas)</p>
              <p className={`text-4xl font-bold ${balance?.isPositive ? 'text-[#22C39A]' : 'text-[#FF5252]'}`}>
                {formatCurrency(balance?.finalBalance || 0)}
              </p>
            </div>
          </div>
        </div>

        {/* Grid Principal */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          {/* 2. Ranking de Gastos (Pareto 80%) */}
          <div className="bg-white rounded-xl shadow-sm border p-6">
            <h3 className="text-lg font-semibold text-[#1A1A1A] mb-4" style={{fontFamily: 'Poppins, sans-serif'}}>
              Principais Gastos (80% da despesa)
            </h3>
            {expenseData?.pareto80?.length > 0 ? (
              <div className="space-y-3">
                {expenseData.pareto80.map((item: any) => (
                  <div key={item.rank} className="flex items-center gap-3">
                    <div className="flex-shrink-0 w-8 h-8 bg-[#FEF2F2] rounded-full flex items-center justify-center text-[#E74C3C] font-semibold text-sm">
                      {item.rank}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center justify-between mb-1">
                        <p className="text-sm font-medium text-[#1A1A1A] truncate" style={{fontFamily: 'Inter, sans-serif'}}>{item.name}</p>
                        <p className="text-sm font-semibold text-[#1A1A1A]" style={{fontFamily: 'Inter, sans-serif'}}>{formatCurrency(item.total)}</p>
                      </div>
                      <div className="w-full bg-[#D9D9D9] rounded-full h-2">
                        <div
                          className="bg-[#E74C3C] h-2 rounded-full transition-all"
                          style={{ width: `${item.percentage}%` }}
                        ></div>
                      </div>
                      <div className="flex justify-between text-xs text-[#4F4F4F] mt-1" style={{fontFamily: 'Inter, sans-serif'}}>
                        <span>{item.percentage.toFixed(1)}%</span>
                        <span>Acumulado: {item.accumulatedPercentage.toFixed(1)}%</span>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <p className="text-[#4F4F4F] text-center py-8" style={{fontFamily: 'Inter, sans-serif'}}>Nenhum gasto registrado no per√≠odo</p>
            )}
          </div>

          {/* 3. Ranking de Receitas */}
          <div className="bg-white rounded-xl shadow-sm border p-6">
            <h3 className="text-lg font-semibold text-[#1A1A1A] mb-4" style={{fontFamily: 'Poppins, sans-serif'}}>
              Principais Receitas
            </h3>
            {incomeData?.ranking?.length > 0 ? (
              <div className="space-y-3">
                {incomeData.ranking.slice(0, 8).map((item: any) => (
                  <div key={item.rank} className="flex items-center gap-3">
                    <div className="flex-shrink-0 w-8 h-8 bg-[#E8F9F4] rounded-full flex items-center justify-center text-[#22C39A] font-semibold text-sm">
                      {item.rank}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center justify-between mb-1">
                        <p className="text-sm font-medium text-[#1A1A1A] truncate" style={{fontFamily: 'Inter, sans-serif'}}>{item.name}</p>
                        <p className="text-sm font-semibold text-[#1A1A1A]" style={{fontFamily: 'Inter, sans-serif'}}>{formatCurrency(item.total)}</p>
                      </div>
                      <div className="w-full bg-[#D9D9D9] rounded-full h-2">
                        <div
                          className="bg-[#22C39A] h-2 rounded-full transition-all"
                          style={{ width: `${item.percentage}%` }}
                        ></div>
                      </div>
                      <p className="text-xs text-[#4F4F4F] mt-1" style={{fontFamily: 'Inter, sans-serif'}}>{item.percentage.toFixed(1)}%</p>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <p className="text-[#4F4F4F] text-center py-8" style={{fontFamily: 'Inter, sans-serif'}}>Nenhuma receita registrada no per√≠odo</p>
            )}
          </div>
        </div>

        {/* 4. Gr√°fico Receitas x Despesas */}
        <div className="bg-white rounded-xl shadow-sm border p-6">
          <h3 className="text-lg font-semibold text-[#1A1A1A] mb-6" style={{fontFamily: 'Poppins, sans-serif'}}>
            Receitas x Despesas (com gastos provisionados)
          </h3>
          {chartData.length > 0 ? (
            <div className="space-y-6">
              {chartData.map((month: any) => (
                <div key={month.month} className="space-y-2">
                  <div className="flex items-center justify-between text-sm">
                    <span className="font-medium text-[#1A1A1A]" style={{fontFamily: 'Inter, sans-serif'}}>{formatMonth(month.month)}</span>
                    <span className={`font-semibold ${month.balance >= 0 ? 'text-[#22C39A]' : 'text-[#E74C3C]'}`} style={{fontFamily: 'Inter, sans-serif'}}>
                      {formatCurrency(month.balance)}
                    </span>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    {/* Receitas */}
                    <div>
                      <div className="flex items-center justify-between mb-1 text-xs text-[#4F4F4F]" style={{fontFamily: 'Inter, sans-serif'}}>
                        <span>Receitas (realizado + provisionado)</span>
                        <span className="font-medium">{formatCurrency(month.totalIncome || month.realizedIncome)}</span>
                      </div>
                      <div className="h-8 bg-[#E8F9F4] rounded overflow-hidden">
                        <div className="h-full flex">
                          <div
                            className="bg-[#22C39A]"
                            style={{
                              width: month.totalIncome ? `${(month.realizedIncome / month.totalIncome) * 100}%` : '100%',
                            }}
                            title={`Realizado: ${formatCurrency(month.realizedIncome)}`}
                          ></div>
                          {month.projectedIncome > 0 && (
                            <div
                              className="bg-[#6DD9B9]"
                              style={{
                                width: `${((month.projectedIncome || 0) / month.totalIncome) * 100}%`,
                              }}
                              title={`Provisionado: ${formatCurrency(month.projectedIncome || 0)}`}
                            ></div>
                          )}
                        </div>
                      </div>
                      <div className="flex items-center gap-3 mt-1 text-xs text-[#4F4F4F]" style={{fontFamily: 'Inter, sans-serif'}}>
                        <span className="flex items-center gap-1">
                          <div className="w-3 h-3 bg-[#22C39A] rounded"></div>
                          Realizado: {formatCurrency(month.realizedIncome)}
                        </span>
                        {month.projectedIncome > 0 && (
                          <span className="flex items-center gap-1">
                            <div className="w-3 h-3 bg-[#6DD9B9] rounded"></div>
                            Provisionado: {formatCurrency(month.projectedIncome || 0)}
                          </span>
                        )}
                      </div>
                    </div>

                    {/* Despesas */}
                    <div>
                      <div className="flex items-center justify-between mb-1 text-xs text-[#4F4F4F]" style={{fontFamily: 'Inter, sans-serif'}}>
                        <span>Despesas (realizado + provisionado)</span>
                        <span className="font-medium">{formatCurrency(month.totalExpense)}</span>
                      </div>
                      <div className="h-8 bg-[#FEF2F2] rounded overflow-hidden">
                        <div className="h-full flex">
                          <div
                            className="bg-[#E74C3C]"
                            style={{
                              width: `${(month.realizedExpense / month.totalExpense) * 100}%`,
                            }}
                            title={`Realizado: ${formatCurrency(month.realizedExpense)}`}
                          ></div>
                          <div
                            className="bg-[#F39C8F]"
                            style={{
                              width: `${(month.projectedExpense / month.totalExpense) * 100}%`,
                            }}
                            title={`Provisionado: ${formatCurrency(month.projectedExpense)}`}
                          ></div>
                        </div>
                      </div>
                      <div className="flex items-center gap-3 mt-1 text-xs text-[#4F4F4F]" style={{fontFamily: 'Inter, sans-serif'}}>
                        <span className="flex items-center gap-1">
                          <div className="w-3 h-3 bg-[#E74C3C] rounded"></div>
                          Realizado: {formatCurrency(month.realizedExpense)}
                        </span>
                        <span className="flex items-center gap-1">
                          <div className="w-3 h-3 bg-[#F39C8F] rounded"></div>
                          Provisionado: {formatCurrency(month.projectedExpense)}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <p className="text-[#4F4F4F] text-center py-8" style={{fontFamily: 'Inter, sans-serif'}}>Nenhum dado dispon√≠vel para o per√≠odo</p>
          )}
        </div>

        {/* A√ß√µes R√°pidas */}
        <div className="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4">
          <button
            onClick={() => handleOpenAddModal('income')}
            className="flex items-center gap-2 p-4 bg-[#E8F9F4] hover:bg-[#D6F5EA] rounded-lg transition-colors text-[#22C39A] font-medium shadow-sm"
            style={{fontFamily: 'Inter, sans-serif'}}
          >
            <ArrowUpRight className="w-5 h-5" />
            Nova Receita
          </button>
          <button
            onClick={() => handleOpenAddModal('expense')}
            className="flex items-center gap-2 p-4 bg-[#FEF2F2] hover:bg-[#FEE2E2] rounded-lg transition-colors text-[#E74C3C] font-medium shadow-sm"
            style={{fontFamily: 'Inter, sans-serif'}}
          >
            <ArrowDownRight className="w-5 h-5" />
            Nova Despesa
          </button>
          <button className="flex items-center gap-2 p-4 bg-[#E8F4FD] hover:bg-[#D6EBFA] rounded-lg transition-colors text-[#1C6DD0] font-medium shadow-sm" style={{fontFamily: 'Inter, sans-serif'}}>
            <PiggyBank className="w-5 h-5" />
            Or√ßamentos
          </button>
          <button className="flex items-center gap-2 p-4 bg-[#E8F4FD] hover:bg-[#D6EBFA] rounded-lg transition-colors text-[#1C6DD0] font-medium shadow-sm" style={{fontFamily: 'Inter, sans-serif'}}>
            <CreditCard className="w-5 h-5" />
            Contas Fixas
          </button>
        </div>
      </main>

      {/* Modal de Per√≠odo */}
      {showPeriodModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl max-w-md w-full p-6 shadow-xl">
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-xl font-bold text-[#1A1A1A]" style={{fontFamily: 'Poppins, sans-serif'}}>Filtrar por Per√≠odo</h3>
              <button onClick={() => setShowPeriodModal(false)} className="p-2 hover:bg-gray-100 rounded-lg">
                <X className="w-5 h-5 text-[#4F4F4F]" />
              </button>
            </div>

            <div className="space-y-4 mb-6">
              <div>
                <label className="block text-sm font-medium text-[#1A1A1A] mb-2" style={{fontFamily: 'Inter, sans-serif'}}>Data Inicial</label>
                <input
                  type="date"
                  value={startDate}
                  onChange={(e) => setStartDate(e.target.value)}
                  className="w-full px-4 py-2 border border-[#D9D9D9] rounded-lg focus:ring-2 focus:ring-[#1C6DD0] focus:border-[#1C6DD0]"
                  style={{fontFamily: 'Inter, sans-serif'}}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-[#1A1A1A] mb-2" style={{fontFamily: 'Inter, sans-serif'}}>Data Final</label>
                <input
                  type="date"
                  value={endDate}
                  onChange={(e) => setEndDate(e.target.value)}
                  className="w-full px-4 py-2 border border-[#D9D9D9] rounded-lg focus:ring-2 focus:ring-[#1C6DD0] focus:border-[#1C6DD0]"
                  style={{fontFamily: 'Inter, sans-serif'}}
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-3 mb-6">
              <button onClick={() => applyQuickFilter('currentMonth')} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium" style={{fontFamily: 'Inter, sans-serif'}}>
                M√™s Atual
              </button>
              <button onClick={() => applyQuickFilter('lastMonth')} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium" style={{fontFamily: 'Inter, sans-serif'}}>
                M√™s Anterior
              </button>
              <button onClick={() => applyQuickFilter('last3Months')} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium" style={{fontFamily: 'Inter, sans-serif'}}>
                √öltimos 3 Meses
              </button>
              <button onClick={() => applyQuickFilter('last6Months')} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium" style={{fontFamily: 'Inter, sans-serif'}}>
                √öltimos 6 Meses
              </button>
              <button onClick={() => applyQuickFilter('currentYear')} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium col-span-2" style={{fontFamily: 'Inter, sans-serif'}}>
                Ano Atual
              </button>
            </div>

            <div className="flex gap-3">
              <button
                onClick={() => setShowPeriodModal(false)}
                className="flex-1 px-4 py-2 border border-[#D9D9D9] rounded-lg hover:bg-gray-50"
                style={{fontFamily: 'Inter, sans-serif'}}
              >
                Cancelar
              </button>
              <button
                onClick={() => setShowPeriodModal(false)}
                className="flex-1 px-4 py-2 bg-[#1C6DD0] text-white rounded-lg hover:bg-[#1557A8] shadow-md"
                style={{fontFamily: 'Inter, sans-serif'}}
              >
                Aplicar
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modal de Adicionar Transa√ß√£o - DESATIVADO, usando TransactionModal agora */}
      {false && showAddModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-xl font-bold text-gray-900">
                Nova {addType === 'income' ? 'Receita' : 'Despesa'}
              </h3>
              <button onClick={() => setShowAddModal(false)} className="p-2 hover:bg-gray-100 rounded-lg">
                <X className="w-5 h-5" />
              </button>
            </div>

            <form onSubmit={handleSubmitTransaction} className="space-y-4">
              {/* Valor */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Valor <span className="text-red-500">*</span>
                </label>
                <div className="relative">
                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">R$</span>
                  <input
                    type="number"
                    step="0.01"
                    required
                    value={formData.amount}
                    onChange={(e) => setFormData({ ...formData, amount: e.target.value })}
                    className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    placeholder="0,00"
                  />
                </div>
              </div>

              {/* Descri√ß√£o */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Descri√ß√£o
                </label>
                <input
                  type="text"
                  value={formData.description}
                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="Ex: Sal√°rio, Compras, etc."
                />
              </div>

              {/* Data */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Data <span className="text-red-500">*</span>
                </label>
                <input
                  type="date"
                  required
                  value={formData.transactionDate}
                  onChange={(e) => setFormData({ ...formData, transactionDate: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                />
              </div>

              {/* Categoria */}
              <div className="relative">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Categoria <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  required
                  value={categorySearch || selectedCategoryName}
                  onChange={(e) => {
                    setCategorySearch(e.target.value);
                    setSelectedCategoryName('');
                    setFormData({ ...formData, categoryId: '' });
                    setShowCategoryDropdown(true);
                  }}
                  onFocus={() => setShowCategoryDropdown(true)}
                  placeholder="üîç Digite para buscar categoria..."
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                />
                
                {/* Dropdown de categorias */}
                {showCategoryDropdown && (categorySearch || !selectedCategoryName) && (
                  <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                    {getFilteredCategories(categories, addType, categorySearch).length > 0 ? (
                      getFilteredCategories(categories, addType, categorySearch).map(({ category, level }) => (
                        <div
                          key={category.id}
                          onClick={() => handleSelectCategory(category)}
                          className="px-4 py-2 hover:bg-blue-50 cursor-pointer transition-colors"
                          style={{ paddingLeft: `${16 + level * 20}px` }}
                        >
                          {category.name}
                        </div>
                      ))
                    ) : (
                      <div className="px-4 py-2 text-gray-500 text-sm">
                        Nenhuma categoria encontrada
                      </div>
                    )}
                  </div>
                )}
              </div>

              {/* Meio de Pagamento */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Meio de Pagamento
                </label>
                <select
                  value={formData.paymentMethodId}
                  onChange={(e) => {
                    if (e.target.value === '_new') {
                      setShowPaymentMethodModal(true);
                      e.target.value = ''; // Reset select
                    } else {
                      setFormData({ ...formData, paymentMethodId: e.target.value });
                    }
                  }}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">Selecione (opcional)</option>
                  {paymentMethods.map(method => (
                    <option key={method.id} value={method.id}>
                      {method.name}
                    </option>
                  ))}
                  <option value="_new" className="text-blue-600 font-semibold">
                    + Novo Meio de Pagamento
                  </option>
                </select>
              </div>

              {/* Conta Banc√°ria */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Conta Banc√°ria {(() => {
                    const selectedMethod = paymentMethods.find(m => m.id === formData.paymentMethodId);
                    const isPix = selectedMethod?.type === 'pix';
                    return !isPix && <span className="text-red-500">*</span>;
                  })()}
                </label>
                <select
                  required={(() => {
                    const selectedMethod = paymentMethods.find(m => m.id === formData.paymentMethodId);
                    return selectedMethod?.type !== 'pix';
                  })()}
                  value={formData.bankAccountId}
                  onChange={(e) => {
                    if (e.target.value === '_new') {
                      setShowBankAccountModal(true);
                      e.target.value = ''; // Reset select
                    } else {
                      setFormData({ ...formData, bankAccountId: e.target.value });
                    }
                  }}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">Selecione uma conta{(() => {
                    const selectedMethod = paymentMethods.find(m => m.id === formData.paymentMethodId);
                    return selectedMethod?.type === 'pix' ? ' (opcional para PIX)' : '';
                  })()}</option>
                  {bankAccounts.map(account => (
                    <option key={account.id} value={account.id}>
                      {account.name} - {formatCurrency(Number(account.currentBalance))}
                    </option>
                  ))}
                  <option value="_new" className="text-blue-600 font-semibold">
                    + Nova Conta Banc√°ria
                  </option>
                </select>
              </div>

              {/* Observa√ß√µes */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Observa√ß√µes
                </label>
                <textarea
                  value={formData.notes}
                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                  rows={3}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="Informa√ß√µes adicionais..."
                />
              </div>

              {/* Bot√µes */}
              <div className="flex gap-3 pt-4">
                <button
                  type="button"
                  onClick={() => setShowAddModal(false)}
                  className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                  disabled={submitting}
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className={`flex-1 px-4 py-2 rounded-lg text-white font-medium ${
                    addType === 'income'
                      ? 'bg-green-600 hover:bg-green-700'
                      : 'bg-red-600 hover:bg-red-700'
                  } ${submitting ? 'opacity-50 cursor-not-allowed' : ''}`}
                  disabled={submitting}
                >
                  {submitting ? 'Salvando...' : 'Salvar'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Modal de Cria√ß√£o de Conta Banc√°ria */}
      {showBankAccountModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-2">
                <Wallet className="text-blue-600" size={24} />
                <h2 className="text-xl font-bold text-gray-900">Nova Conta Banc√°ria</h2>
              </div>
              <button
                onClick={() => setShowBankAccountModal(false)}
                className="text-gray-400 hover:text-gray-600"
                disabled={submitting}
              >
                <X size={20} />
              </button>
            </div>

            <form onSubmit={handleCreateBankAccount} className="space-y-4">
              {/* Nome */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Nome da Conta <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  required
                  value={bankAccountForm.name}
                  onChange={(e) => setBankAccountForm({ ...bankAccountForm, name: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="Ex: Conta Corrente Ita√∫"
                />
              </div>

              {/* Tipo */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Tipo <span className="text-red-500">*</span>
                </label>
                <select
                  required
                  value={bankAccountForm.type}
                  onChange={(e) => setBankAccountForm({ ...bankAccountForm, type: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="bank">Conta Banc√°ria</option>
                  <option value="wallet">Carteira Digital</option>
                  <option value="credit_card">Cart√£o de Cr√©dito</option>
                  <option value="investment">Investimento</option>
                </select>
              </div>

              {/* Institui√ß√£o */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Institui√ß√£o Financeira <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  required
                  value={bankAccountForm.institution}
                  onChange={(e) => setBankAccountForm({ ...bankAccountForm, institution: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="Ex: Banco Ita√∫, Nubank, PicPay..."
                />
              </div>

              {/* Saldo Inicial */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Saldo Inicial <span className="text-red-500">*</span>
                </label>
                <div className="relative">
                  <span className="absolute left-3 top-2.5 text-gray-500">R$</span>
                  <input
                    type="number"
                    required
                    step="0.01"
                    min="0"
                    value={bankAccountForm.initialBalance}
                    onChange={(e) => setBankAccountForm({ ...bankAccountForm, initialBalance: e.target.value })}
                    className="w-full pl-12 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    placeholder="0.00"
                  />
                </div>
              </div>

              {/* Bot√µes */}
              <div className="flex gap-3 pt-4">
                <button
                  type="button"
                  onClick={() => setShowBankAccountModal(false)}
                  className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                  disabled={submitting}
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className={`flex-1 px-4 py-2 rounded-lg text-white font-medium bg-blue-600 hover:bg-blue-700 ${
                    submitting ? 'opacity-50 cursor-not-allowed' : ''
                  }`}
                  disabled={submitting}
                >
                  {submitting ? 'Criando...' : 'Criar Conta'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Modal de Cria√ß√£o de Meio de Pagamento */}
      {showPaymentMethodModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-2">
                <CreditCard className="text-blue-600" size={24} />
                <h2 className="text-xl font-bold text-gray-900">Novo Meio de Pagamento</h2>
              </div>
              <button
                onClick={() => setShowPaymentMethodModal(false)}
                className="text-gray-400 hover:text-gray-600"
                disabled={submitting}
              >
                <X size={20} />
              </button>
            </div>

            <form onSubmit={handleCreatePaymentMethod} className="space-y-4">
              {/* Nome */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Nome <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  required
                  value={paymentMethodForm.name}
                  onChange={(e) => setPaymentMethodForm({ ...paymentMethodForm, name: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="Ex: PIX Nubank, Cart√£o Ita√∫, Dinheiro..."
                />
              </div>

              {/* Tipo */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Tipo <span className="text-red-500">*</span>
                </label>
                <select
                  required
                  value={paymentMethodForm.type}
                  onChange={(e) => setPaymentMethodForm({ ...paymentMethodForm, type: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="pix">PIX</option>
                  <option value="credit_card">Cart√£o de Cr√©dito</option>
                  <option value="debit_card">Cart√£o de D√©bito</option>
                  <option value="boleto">Boleto</option>
                  <option value="cash">Dinheiro</option>
                  <option value="bank_transfer">Transfer√™ncia Banc√°ria</option>
                  <option value="automatic_debit">D√©bito Autom√°tico</option>
                </select>
              </div>

              {/* Conta Banc√°ria (para PIX, cart√µes e transfer√™ncias) */}
              {(paymentMethodForm.type === 'pix' || 
                paymentMethodForm.type === 'credit_card' || 
                paymentMethodForm.type === 'debit_card' || 
                paymentMethodForm.type === 'bank_transfer') && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Conta Banc√°ria Vinculada {(paymentMethodForm.type === 'credit_card' || paymentMethodForm.type === 'debit_card') && <span className="text-red-500">*</span>}
                  </label>
                  <select
                    required={paymentMethodForm.type === 'credit_card' || paymentMethodForm.type === 'debit_card'}
                    value={paymentMethodForm.bankAccountId}
                    onChange={(e) => setPaymentMethodForm({ ...paymentMethodForm, bankAccountId: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">Selecione uma conta</option>
                    {bankAccounts.map(account => (
                      <option key={account.id} value={account.id}>
                        {account.name}
                      </option>
                    ))}
                  </select>
                  <p className="text-xs text-gray-500 mt-1">
                    {paymentMethodForm.type === 'credit_card' && 'Conta de onde ser√° paga a fatura'}
                    {paymentMethodForm.type === 'debit_card' && 'Conta vinculada ao cart√£o'}
                    {paymentMethodForm.type === 'pix' && 'Conta do PIX (opcional)'}
                  </p>
                </div>
              )}

              {/* Campos espec√≠ficos para cart√µes */}
              {(paymentMethodForm.type === 'credit_card' || paymentMethodForm.type === 'debit_card') && (
                <>
                  <div className="grid grid-cols-2 gap-3">
                    {/* √öltimos 4 d√≠gitos */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        √öltimos 4 d√≠gitos
                      </label>
                      <input
                        type="text"
                        maxLength={4}
                        value={paymentMethodForm.lastFourDigits}
                        onChange={(e) => setPaymentMethodForm({ ...paymentMethodForm, lastFourDigits: e.target.value.replace(/\D/g, '') })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="2277"
                      />
                    </div>

                    {/* Bandeira */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Bandeira
                      </label>
                      <select
                        value={paymentMethodForm.cardNetwork}
                        onChange={(e) => setPaymentMethodForm({ ...paymentMethodForm, cardNetwork: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="">Selecione</option>
                        <option value="visa">Visa</option>
                        <option value="mastercard">Mastercard</option>
                        <option value="elo">Elo</option>
                        <option value="amex">American Express</option>
                        <option value="hipercard">Hipercard</option>
                        <option value="other">Outra</option>
                      </select>
                    </div>
                  </div>

                  {/* Data de Vencimento */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Data de Vencimento
                    </label>
                    <input
                      type="month"
                      value={paymentMethodForm.expirationDate}
                      onChange={(e) => setPaymentMethodForm({ ...paymentMethodForm, expirationDate: e.target.value })}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                </>
              )}

              {/* Bot√µes */}
              <div className="flex gap-3 pt-4">
                <button
                  type="button"
                  onClick={() => setShowPaymentMethodModal(false)}
                  className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                  disabled={submitting}
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  className={`flex-1 px-4 py-2 rounded-lg text-white font-medium bg-blue-600 hover:bg-blue-700 ${
                    submitting ? 'opacity-50 cursor-not-allowed' : ''
                  }`}
                  disabled={submitting}
                >
                  {submitting ? 'Criando...' : 'Criar Meio de Pagamento'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
      
      {/* Modal de Transa√ß√£o Unificado */}
      <TransactionModal
        isOpen={showAddModal}
        onClose={() => setShowAddModal(false)}
        onSuccess={() => loadDashboardData()}
        defaultType={addType}
      />
    </div>
  );
}
